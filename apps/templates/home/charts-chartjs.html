{% extends "layouts/base.html" %} {% block title %} ChartsJS {% endblock %}

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

<!-- Google Font: Source Sans Pro -->
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
/>
<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="/static/assets/plugins/fontawesome-free/css/all.min.css"
/>
<!-- Theme style -->
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css" />
<!-- AXIOS -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

{% endblock stylesheets %} {% block content %}
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Gráficos Estadísticos</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Usuarios por Género</li>
          </ol>
        </div>
      </div>
    </div>
    <!-- /.container-fluid -->
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <!-- BAR CHART PARA USUARIOS FEMENINOS Y MASCULINOS -->
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">Usuarios por Género</h3>
              <div class="card-tools">
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="collapse"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="remove"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas
                  id="genderChart"
                  style="
                    min-height: 250px;
                    height: 250px;
                    max-height: 250px;
                    max-width: 100%;
                  "
                ></canvas>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
          <!-- /.col -->
          <div class="card card-success">
            <div class="card-header">
              <h3 class="card-title">Distribución de Usuarios por Rol</h3>
              <div class="card-tools">
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="collapse"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="remove"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <canvas
                id="roleChart"
                style="
                  min-height: 250px;
                  height: 250px;
                  max-height: 250px;
                  max-width: 100%;
                "
              ></canvas>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
          <div class="card card-success">
            <div class="card-header">
              <h3 class="card-title">Conteo Nacionalidades</h3>
              <div class="card-tools">
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="collapse"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="remove"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <canvas id="nacionalidadChart" style="min-height: 400px"></canvas>
            </div>
            <!-- /.card-body -->
          </div>
        </div>
      </div>
      <!-- /.row -->
      <!-- Additional Card for Educational Level -->
      <div class="col-md-6">
        <div class="card card-info">
          <div class="card-header">
            <h3 class="card-title">Distribución por Nivel Educativo</h3>
            <div class="card-tools">
              <button
                type="button"
                class="btn btn-tool"
                data-card-widget="collapse"
              >
                <i class="fas fa-minus"></i>
              </button>
              <button
                type="button"
                class="btn btn-tool"
                data-card-widget="remove"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <canvas id="educationChart" style="min-height: 250px"></canvas>
          </div>
          <!-- /.card-body -->
        </div>
      </div>

      <!-- Additional Card for Registered Members -->
      <div class="col-md-6">
        <div class="card card-warning">
          <div class="card-header">
            <h3 class="card-title">Miembros Colegiados</h3>
            <div class="card-tools">
              <button
                type="button"
                class="btn btn-tool"
                data-card-widget="collapse"
              >
                <i class="fas fa-minus"></i>
              </button>
              <button
                type="button"
                class="btn btn-tool"
                data-card-widget="remove"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <canvas
              id="registeredMembersChart"
              style="min-height: 250px"
            ></canvas>
          </div>
          <!-- /.card-body -->
        </div>
      </div>
    </div>
    <!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<!-- jQuery -->
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="/static/assets/plugins/chart.js/Chart.min.js"></script>
<!-- AdminLTE App -->
<script src="/static/assets/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/static/assets/js/demo.js"></script>
<!-- page script -->
<script>
  $(document).ready(function () {
    // Llamada al endpoint para obtener datos de usuarios
    axios
      .get("http://62.72.11.15:8090/usuarios")
      .then(function (response) {
        var usuarios = response.data;

        // Contar usuarios masculinos y femeninos
        var masculinos = 0;
        var femeninos = 0;
        var roles = {}; // Objeto para almacenar la cuenta de cada rol

        // Iterar sobre los usuarios y contar por género y roles
        usuarios.forEach(function (usuario) {
          if (usuario.usuario_sexo === "Masculino") {
            masculinos++;
          } else if (usuario.usuario_sexo === "Femenino") {
            femeninos++;
          }

          var rol = usuario.usuario_rol;
          roles[rol] = (roles[rol] || 0) + 1;
        });

        // Gráfico de género
        var genderChartCanvas = $("#genderChart").get(0).getContext("2d");
        var total = masculinos + femeninos;
        var char_total = "Total Users:" + total;
        var genderChartData = {
          labels: ["Masculino", "Femenino", "Total Users"],
          datasets: [
            {
              data: [masculinos, femeninos, total],
              backgroundColor: [
                "rgba(75, 192, 192, 0.2)", // Color para usuarios masculinos
                "rgba(255, 99, 132, 0.2)", // Color para usuarios femeninos
                "rgba(40, 12, 12, 0.2)",
              ],
              borderColor: ["rgba(75, 192, 192, 1)", "rgba(255, 99, 132, 1)"],
              borderWidth: 1,
            },
          ],
        };
        var genderChartOptions = {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            xAxes: [
              {
                gridLines: {
                  display: false,
                },
              },
            ],
            yAxes: [
              {
                ticks: {
                  beginAtZero: true,
                  fontSize: 14, // Tamaño del texto en el eje y
                },
              },
            ],
          },
        };
        var genderChart = new Chart(genderChartCanvas, {
          type: "bar",
          data: genderChartData,
          options: genderChartOptions,
        });

        // Gráfico de roles
        var rolesLabels = Object.keys(roles);
        var rolesData = Object.values(roles);
        var pieColors = [
          "rgba(255, 99, 132, 0.7)",
          "rgba(255, 205, 86, 0.7)",
          "rgba(54, 162, 235, 0.7)",
          "rgba(75, 192, 192, 0.7)",
        ];
        var roleChartCanvas = $("#roleChart").get(0).getContext("2d");
        var roleChartData = {
          labels: rolesLabels,
          datasets: [
            {
              data: rolesData,
              backgroundColor: pieColors,
              borderWidth: 1,
            },
          ],
        };
        var roleChartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            position: "right",
          },
        };
        var roleChart = new Chart(roleChartCanvas, {
          type: "pie",
          data: roleChartData,
          options: roleChartOptions,
        });
      })
      .catch(function (error) {
        console.error(error);
      });

    // Realizar la solicitud GET para obtener las nacionalidades de los trabajadores
    axios
      .get("http://62.72.11.15:8090/trabajadores")
      .then(function (response) {
        var trabajadores = response.data;

        // Obtener todas las nacionalidades únicas de los trabajadores
        var nacionalidades = [
          ...new Set(
            trabajadores.map((trabajador) => trabajador.trabajador_nacionalidad)
          ),
        ];

        // Contar trabajadores por nacionalidad
        var trabajadoresPorNacionalidad = nacionalidades.map((nacionalidad) => {
          return {
            nacionalidad: nacionalidad,
            cantidad: trabajadores.filter(
              (trabajador) =>
                trabajador.trabajador_nacionalidad === nacionalidad
            ).length,
          };
        });

        // Ordenar el array por cantidad de trabajadores de forma ascendente
        trabajadoresPorNacionalidad.sort((a, b) => a.cantidad - b.cantidad);

        // Obtener etiquetas (nombres de nacionalidades) y datos (cantidades de trabajadores) para el gráfico
        var labels = trabajadoresPorNacionalidad.map(
          (item) => item.nacionalidad
        );
        var data = trabajadoresPorNacionalidad.map((item) => item.cantidad);

        // Crear el gráfico lineal de trabajadores por nacionalidad
        var nacionalidadChartCanvas = $("#nacionalidadChart")
          .get(0)
          .getContext("2d");
        var nacionalidadChartData = {
          labels: labels,
          datasets: [
            {
              label: "Trabajadores por Nacionalidad",
              data: data,
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 2,
              pointBackgroundColor: "rgba(75, 192, 192, 1)",
              fill: false,
            },
          ],
        };
        var nacionalidadChartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            yAxes: [
              {
                ticks: {
                  beginAtZero: true,
                  fontSize: 14,
                },
              },
            ],
            xAxes: [
              {
                ticks: {
                  fontSize: 14,
                },
              },
            ],
          },
        };
        var nacionalidadChart = new Chart(nacionalidadChartCanvas, {
          type: "bar",
          data: nacionalidadChartData,
          options: nacionalidadChartOptions,
        });
      })
      .catch(function (error) {
        console.error(error);
      });
  });
</script>

{% endblock javascripts %}
